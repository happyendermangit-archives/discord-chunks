{
    "exports": {
        "default": "class R extends s.default{constructor(e,t,n){super(e,t),this.mediaEngineConnectionId=`Native-${N++}`,this.selfMute=!1,this.selfVideo=!1,this.forceAudioNormal=!1,this.forceAudioPriority=!1,this.codecs=[],this.videoEncoderFallbackPending=!1,this.desktopDegradationPreference=(0,T.getVoiceEngine)().DegradationPreference.MAINTAIN_FRAMERATE,this.sourceDesktopDegradationPreference=(0,T.getVoiceEngine)().DegradationPreference.DISABLED,this.videoDegradationPreference=(0,T.getVoiceEngine)().DegradationPreference.BALANCED,this.localPans={},this.remoteAudioSSRCs={},this.remoteVideoSSRCs={},this.inputMode=A.InputModes.VOICE_ACTIVITY,this.vadThreshold=-40,this.vadAutoThreshold=!0,this.vadUseKrisp=!0,this.vadLeading=5,this.vadTrailing=25,this.pttReleaseDelay=20,this.soundshareActive=!1,this.soundshareId=null,this.soundshareSentSpeakingEvent=!1,this.echoCancellation=!0,this.noiseSuppression=!0,this.automaticGainControl=!0,this.noiseCancellation=!1,this.experimentalEncoders=!1,this.hardwareH264=!0,this.attenuationFactor=.5,this.attenuateWhileSpeakingSelf=!1,this.attenuateWhileSpeakingOthers=!0,this.qos=!0,this.minimumJitterBufferLevel=0,this.postponeDecodeLevel=100,this.reconnectInterval=6e4,this.keyframeInterval=0,this.clipsKeyFrameInterval=0,this.videoQualityMeasurement=\"\",this.videoEncoderExperiments=\"\",this.numFastUdpReconnects=0,this.handleSpeakingNative=(e,t)=>{let n=A.SpeakingFlags.NONE;n=\"boolean\"==typeof t?t?A.SpeakingFlags.VOICE:A.SpeakingFlags.NONE:t,this.handleSpeakingFlags(e,n)},this.handleSpeakingFlags=(e,t)=>{this.localSpeakingFlags[e]=t;let n=e===this.ids.userId?this.audioSSRC:this.remoteAudioSSRCs[e];this.emit(l.BaseConnectionEvent.Speaking,e,t,n),(t&A.SpeakingFlags.SOUNDSHARE)!=0&&!1===this.soundshareSentSpeakingEvent&&(this.emit(l.BaseConnectionEvent.SoundshareSpeaking),this.soundshareSentSpeakingEvent=!0)},this.handleSpeakingWhileMuted=()=>{this.emit(l.BaseConnectionEvent.SpeakingWhileMuted)},this.handlePing=(e,t,n)=>{this.emit(l.BaseConnectionEvent.Ping,e)},this.handlePingTimeout=(e,t,n,i)=>{this.emit(l.BaseConnectionEvent.PingTimeout,n,i>0?i:4e3)},this.handleVideoEncoderFallback=e=>{!this.videoEncoderFallbackPending&&(this.logger.info(\"Falling back from current video encoder:\"+e),this.codecs=this.codecs.map(t=>((e===t.name||\"AV1\"===t.name&&\"AV1X\"===e)&&(t.encode=!1),t)).filter(e=>!(\"video\"===e.type&&!1===e.encode&&!1===e.decode)),this.emit(l.BaseConnectionEvent.VideoEncoderFallback,this.codecs),this.videoEncoderFallbackPending=!0)},this.handleVideo=(e,t,n,i)=>{let o=r().cloneDeep(this.videoStreamParameters);e===this.ids.userId?null!=i&&Array.isArray(i)&&i.length>0?i.forEach(e=>{o.forEach((t,n)=>{t.rid===e.rid&&(o[n]={...t,ssrc:e.ssrc,rtxSsrc:e.rtxSsrc,active:e.active})})}):t>0?(o[0].active=!0,o[0].ssrc=t,o[0].rtxSsrc=O(t)):o[0].active=!1:t>0&&(void 0!==this.remoteVideoSSRCs[e]?!this.remoteVideoSSRCs[e].includes(t)&&(this.remoteVideoSSRCs[e]=[...this.remoteVideoSSRCs[e],t]):this.remoteVideoSSRCs[e]=[t]),this.videoStreamParameters=o,this.emit(l.BaseConnectionEvent.Video,e,null!=n&&\"\"!==n?n:null,e===this.ids.userId?this.audioSSRC:this.remoteAudioSSRCs[e],t,O(t),this.videoStreamParameters)},this.handleFirstFrame=(e,t,n)=>{this.emit(l.BaseConnectionEvent.FirstFrame,e,t,n)},this.handleNoInput=e=>{this.emit(l.BaseConnectionEvent.Silence,!e)},this.handleDesktopSourceEnded=()=>{this.emit(l.BaseConnectionEvent.DesktopSourceEnd)},this.handleSoundshare=e=>{e&&(this.soundshareActive=!0,this.conn.setTransportOptions({encodingVoiceBitRate:Math.max(A.DEFAULT_SOUNDSHARE_VOICE_BITRATE,this.voiceBitrate)}),this.emit(l.BaseConnectionEvent.SoundshareAttached))},this.handleSoundshareFailed=(e,t,n)=>{this.emit(l.BaseConnectionEvent.SoundshareFailed,{failureCode:e,failureReason:t,willRetry:n})},this.handleSoundshareEnded=()=>{this.soundshareActive=!1,!this.destroyed&&this.conn.setTransportOptions({encodingVoiceBitRate:this.voiceBitrate})},this.handleNewListenerNative=e=>{if(e===l.BaseConnectionEvent.ConnectionStateChange)this.emit(e,this.connectionState)},this.handleStats=e=>{if(this.connectionState===A.ConnectionStates.DISCONNECTED){this.off(l.BaseConnectionEvent.Stats,this.handleStats);return}if(null!=e){if(null!=this.stats){let t=r().reduce(e.rtp.outbound,(e,t)=>(e.lost+=t.packetsLost??0,e.sent+=t.packetsSent??0,e),{lost:0,sent:0}),n=r().reduce(this.stats.rtp.outbound,(e,t)=>(e.lost+=t.packetsLost??0,e.sent+=t.packetsSent??0,e),{lost:0,sent:0}),i=t.sent-n.sent,o=t.lost-n.lost;if(0===i)this.emit(l.BaseConnectionEvent.OutboundLossRate,0);else if(i>0&&o>=0){let e=r().clamp(o/(i+o),0,1);this.emit(l.BaseConnectionEvent.OutboundLossRate,100*e)}let a=e.rtp.outbound.filter(e=>\"audio\"===e.type)[0],s=this.stats.rtp.outbound.filter(e=>\"audio\"===e.type)[0];if(null!=a&&null!=s&&null!=a.framesCaptured&&null!=s.framesCaptured){let e=a.framesCaptured-s.framesCaptured;if(this.noiseCancellation&&e>50&&null!=a.noiseCancellerProcessTime&&null!=s.noiseCancellerProcessTime){let t=a.noiseCancellerProcessTime-s.noiseCancellerProcessTime;t/e>8?this.emit(l.BaseConnectionEvent.NoiseCancellationError,A.NoiseCancellerError.CPU_OVERUSE):0===t&&this.emit(l.BaseConnectionEvent.NoiseCancellationError,A.NoiseCancellerError.FAILED)}this.inputMode===A.InputModes.VOICE_ACTIVITY&&this.vadAutoThreshold&&this.vadUseKrisp&&e>50&&null!=a.voiceActivityDetectorProcessTime&&null!=s.voiceActivityDetectorProcessTime&&(a.voiceActivityDetectorProcessTime-s.voiceActivityDetectorProcessTime)/e>4&&this.emit(l.BaseConnectionEvent.VoiceActivityDetectorError,A.NoiseCancellerError.VAD_CPU_OVERUSE)}}this.stats=e}},this.logger=new a.default(`Connection(${e})`),this.videoSupported=n}static create(e,t,n){let i=new R(e,t,!0);return i.initialize(n),i}static createReplay(e,t){let n=new R(e,{userId:\"0\",channelId:\"0\",guildId:\"0\"},!0),i=(0,T.getVoiceEngine)();n.initializeStreamParameters([{type:S.MediaTypes.VIDEO,rid:\"100\",ssrc:0,rtxSsrc:0,quality:100,active:!1}]);let r=i.createReplayConnection(\"default\",(t,r)=>{let o=null!=i.getCodecCapabilities?i.getCodecCapabilities:i.getSupportedVideoCodecs;n.on(l.BaseConnectionEvent.Stats,n.handleStats),n.conn.setOnVideoCallback(n.handleVideo),o(t=>{let i=(0,u.getExperimentCodecs)(n.experimentFlags,A.MediaEngineContextTypes.DEFAULT);n.codecs=[{type:\"audio\",name:A.Codecs.OPUS,priority:1,payloadType:120},...(0,u.filterVideoCodecs)(t,i).map((e,t)=>{let n=101+2*t;return{type:\"video\",name:e.name,priority:t+1,payloadType:n,rtxPayloadType:n+1,encode:e.encode,decode:e.decode}})],n.setCodecs(A.Codecs.OPUS,A.Codecs.H264,e),n.conn.startReplay()})},t);return null==r?null:(n.conn=r,n)}initialize(e){let t;this.logger.info(`Creating connection to ${e.address}:${e.port} with audio ssrc: ${e.ssrc}`),this.audioSSRC=e.ssrc,this.streamUserId=e.streamUserId,this.initializeStreamParameters(e.streamParameters),e.streamParameters=this.videoStreamParameters;let n=(0,T.getVoiceEngine)(),i=null!=n.getCodecCapabilities?n.getCodecCapabilities:n.getSupportedVideoCodecs;if(null!=n.createOwnStreamConnectionWithOptions)r=this.context===A.MediaEngineContextTypes.STREAM&&this.streamUserId===this.ids.userId?n.createOwnStreamConnectionWithOptions:n.createVoiceConnectionWithOptions;else if(null!=n.createOwnStreamConnection){var r,o=this.context===A.MediaEngineContextTypes.STREAM&&this.streamUserId===this.ids.userId?n.createOwnStreamConnection:n.createVoiceConnection;r=(e,t,n)=>o(t.ssrc,this.ids.userId,t.address,t.port,n,t.experiments,t.streamParameters)}else r=(e,t,i)=>new n.VoiceConnection(t.ssrc,e,t.address,t.port,i,t.experiments,t.streamParameters);t=this.conn=r(this.ids.userId,e,(r,o)=>{if(this.destroyed)return;if(null!=r&&\"\"!==r){this.setConnectionState(A.ConnectionStates.NO_ROUTE),this.emit(l.BaseConnectionEvent.Error,r);return}if(null==o)throw Error(\"Invalid transport info\");let{protocol:a,address:s,port:_}=o;this.logger.info(`Connected with local address ${s}:${_} and protocol: ${a}`),i(i=>{let r=(0,u.getExperimentCodecs)(this.experimentFlags,this.context);this.codecs=[{type:\"audio\",name:A.Codecs.OPUS,priority:1,payloadType:120},...(0,u.filterVideoCodecs)(i,r).map((e,t)=>{let n=101+2*t;return{type:\"video\",name:e.name,priority:t+1,payloadType:n,rtxPayloadType:n+1,encode:e.encode,decode:e.decode}})],this.logger.info(`Video codecs: ${this.codecs.map(e=>e.name)}`),t.getEncryptionModes(i=>{this.logger.info(`Encryption modes: ${i}`),t.setTransportOptions(this.getConnectionTransportOptions()),t.setSelfMute(this.selfMute||this.context===A.MediaEngineContextTypes.STREAM),t.setSelfDeafen(this.selfDeaf),t.setOnSpeakingCallback(this.handleSpeakingNative),t.setOnSpeakingWhileMutedCallback?.(this.handleSpeakingWhileMuted),t.setPingInterval?.(A.PING_INTERVAL),t.setPingCallback(this.handlePing),t.setPingTimeoutCallback?.(this.handlePingTimeout),t.setOnVideoEncoderFallbackCallback?.(this.handleVideoEncoderFallback),n.setTransportOptions({builtInEchoCancellation:!0,echoCancellation:this.echoCancellation,noiseSuppression:this.noiseSuppression,automaticGainControl:this.automaticGainControl,noiseCancellation:this.noiseCancellation}),n.setNoInputThreshold(-100),n.setNoInputCallback(this.handleNoInput),this.videoSupported&&(t.setOnVideoCallback(this.handleVideo),t.setOnFirstFrameCallback?.(this.handleFirstFrame),t.setOnDesktopSourceEnded?.(this.handleDesktopSourceEnded),t.setOnSoundshare?.(this.handleSoundshare),t.setOnSoundshareEnded?.(this.handleSoundshareEnded),t.setOnSoundshareFailed?.(this.handleSoundshareFailed)),this.setConnectionState(A.ConnectionStates.CONNECTED),this.emit(l.BaseConnectionEvent.Connected,a,{address:s,port:_,mode:this.chooseEncryptionMode(e.modes,i),codecs:this.codecs}),this.on(l.BaseConnectionEvent.Stats,this.handleStats);let r=this.getUserOptions();for(let e of(r.forEach(e=>this.logger.info(`Creating user: ${e.id} with audio SSRC: ${e.ssrc} and video SSRCs: ${e.videoSsrcs?.join(\",\")??0}`)),t.mergeUsers(r),this.emit(l.BaseConnectionEvent.RemoteStreamsReady,r.length),Object.keys(this.localSpeakingFlags)))e!==this.ids.userId&&this.setSpeakingFlags(e,this.localSpeakingFlags[e])})})}),t.setDesktopSourceStatusCallback?.(e=>{\"videohook_start\"===e.type?this.emit(l.BaseConnectionEvent.VideoHookStart):\"videohook_stop\"===e.type?this.emit(l.BaseConnectionEvent.VideoHookStop):\"videohook_initialize\"===e.type?this.emit(l.BaseConnectionEvent.VideoHookInitialize,e.backend,e.format,e.framebufferFormat,e.sampleCount,e.success,e.reinitialization):\"screenshare_finish\"===e.type?this.emit(l.BaseConnectionEvent.ScreenshareFinish,e.screenshareFrames,e.videohookFrames,e.hybridDxgiFrames,e.hybridGdiFrames,e.hybridVideohookFrames,e.hybridGraphicsCaptureFrames,e.hybridCaptureMethodSwitches,e.quartzFrames,e.desktopCapturerType??e.desktop_capturer_type,e.screens,e.windows,e.activity,e.goLiveCameraFrames,e.screenCaptureKitFrames):\"video_state\"===e.type?this.emit(l.BaseConnectionEvent.VideoState,e.state):e.type.startsWith(\"soundshare_\")&&this.emit(l.BaseConnectionEvent.SoundshareTrace,e)}),this.on(\"newListener\",this.handleNewListenerNative)}destroy(){this.conn.destroy(),r()(this.localSpeakingFlags).keys().reject(e=>e===this.ids.userId).forEach(e=>this.emit(l.BaseConnectionEvent.Speaking,e,A.SpeakingFlags.NONE,this.remoteAudioSSRCs[e])),this.setConnectionState(A.ConnectionStates.DISCONNECTED),super.destroy()}setCodecs(e,t,n){this.conn.setTransportOptions(this.getCodecOptions(e,t,n)),this.videoEncoderFallbackPending&&(this.videoEncoderFallbackPending=!1)}getStats(){return this.connectionState===A.ConnectionStates.DISCONNECTED?Promise.resolve(null):(0,o.timeout)(new Promise(e=>{null!=this.conn.getFilteredStats?this.conn.getFilteredStats(S.StatsFilter.ALL,t=>e((0,c.default)(this.mediaEngineConnectionId,t,this.remoteVideoSinkWants,this.localVideoSinkWants))):null!=this.conn.getStats?this.conn.getStats(t=>e((0,c.default)(this.mediaEngineConnectionId,t,this.remoteVideoSinkWants,this.localVideoSinkWants))):(0,T.getVoiceEngine)().getStats(t=>e((0,c.default)(this.mediaEngineConnectionId,t,this.remoteVideoSinkWants,this.localVideoSinkWants)))}),_.STATS_INTERVAL).catch(e=>{if(!(e instanceof o.TimeoutError))throw e})}createUser(e,t,n){if(0===t){this.logger.warn(`Attempting to create user ${e} with 0 audio SSRC`);return}let i=this.remoteAudioSSRCs[e],o=this.remoteVideoSSRCs[e];o=void 0!==o?[...o].sort():[],n=void 0===n?o??[]:[...n].sort();let a=!r().isEqual(o,n);if(this.remoteAudioSSRCs[e]=t,this.remoteVideoSSRCs[e]=n??[],this.ids.userId!==e&&(i!==t||a)){let i=void 0!==n&&n.length>0?n[0]:0,r={id:e,ssrc:t,videoSsrc:i,videoSsrcs:n,rtxSsrc:O(i),mute:this.getLocalMute(e),volume:this.getLocalVolume(e)};this.connectionState===A.ConnectionStates.CONNECTED&&(this.logger.info(`Creating user: ${e} with audio SSRC: ${t} and video SSRCs: ${n?.join(\",\")??0}`),this.conn.mergeUsers([r]));let o=this.localPans[e];null!=o&&this.setLocalPan(e,o.left,o.right);let a=this.localSpeakingFlags[e];null!=a&&a!==A.SpeakingFlags.NONE&&this.setSpeakingFlags(e,a)}}destroyUser(e){null!=this.remoteAudioSSRCs[e]&&(this.conn.destroyUser(e),delete this.remoteAudioSSRCs[e],delete this.remoteVideoSSRCs[e])}setSelfMute(e){this.selfMute=e,this.conn.setSelfMute(e),this.emit(l.BaseConnectionEvent.Mute,e)}setSelfDeaf(e){this.selfDeaf=e,this.conn.setSelfDeafen(e)}setSoundshareSource(e,t){if(this.soundshareId===e&&this.soundshareSentSpeakingEvent||this.context!==A.MediaEngineContextTypes.STREAM)return;this.soundshareId=e,this.soundshareSentSpeakingEvent=!1;let n=e;null===n&&(n=0),this.conn.setTransportOptions({soundsharePid:n,soundshareEventDriven:!0,soundshareLoopback:t})}setLocalMute(e,t){this.localMutes[e]=t,this.conn.setLocalMute(e,t),this.emit(l.BaseConnectionEvent.LocalMute,e,t)}fastUdpReconnect(){null!=this.conn.fastUdpReconnect&&(this.numFastUdpReconnects+=1,this.conn.fastUdpReconnect())}getNumFastUdpReconnects(){return null!=this.conn.fastUdpReconnect?this.numFastUdpReconnects:null}setLocalVideoDisabled(e,t){this.disabledLocalVideos[e]=t,this.emit(l.BaseConnectionEvent.LocalVideoDisabled,e,t)}setMinimumJitterBufferLevel(e){this.minimumJitterBufferLevel=e}setPostponeDecodeLevel(e){this.postponeDecodeLevel=e}setClipRecordUser(e,t,n){!this.destroyed&&this.conn.setClipRecordUser(e,(this.context===A.MediaEngineContextTypes.STREAM?\"application\":\"user\").concat(\"audio\"===t?\"Audio\":\"Video\"),n)}setClipsKeyFrameInterval(e){this.context===A.MediaEngineContextTypes.STREAM&&(this.clipsKeyFrameInterval=e,this.conn.setTransportOptions({keyframeInterval:this.getKeyFrameInterval(),alwaysSendVideo:this.keyframeInterval>0}))}setViewerSideClip(e){this.context===A.MediaEngineContextTypes.STREAM&&this.conn.setTransportOptions({enableViewerSideClip:e})}setQualityDecoupling(e){this.context===A.MediaEngineContextTypes.STREAM&&this.conn.setTransportOptions({enableQualityDecoupling:e})}getLocalVolume(e){var t;let n=this.localVolumes[e];return null==n&&(n=this.context===A.MediaEngineContextTypes.DEFAULT?A.DEFAULT_VOLUME:A.DEFAULT_STREAM_VOLUME),(null!=(t=n)?t:A.DEFAULT_VOLUME)/A.DEFAULT_VOLUME}setLocalVolume(e,t){this.localVolumes[e]=t;try{this.conn.setLocalVolume(e,this.getLocalVolume(e))}catch{this.logger.warn(`Failed to set volume for user: ${e}: ${t}`)}}setLocalPan(e,t,n){this.localPans[e]={left:t,right:n},this.conn.setLocalPan(e,t,n)}isAttenuating(){return this.attenuationFactor<1}setAttenuation(e,t,n){this.attenuationFactor=(100-e)/100,this.attenuateWhileSpeakingSelf=t,this.attenuateWhileSpeakingOthers=n,this.conn.setTransportOptions(this.getAttenuationOptions())}setCanHavePriority(e,t){this.conn.setRemoteUserCanHavePriority?.(e,t)}setBitRate(e){this.setVoiceBitRate(e)}setVoiceBitRate(e){if(this.voiceBitrate===e)return;this.voiceBitrate=e;let t=this.voiceBitrate;this.soundshareActive&&(t=Math.max(A.DEFAULT_SOUNDSHARE_VOICE_BITRATE,t)),this.conn.setTransportOptions({encodingVoiceBitRate:t})}setCameraBitRate(e,t,n){null!=n||null!=t?this.videoQualityManager.setQuality({bitrateMin:null!=n&&n>0?n:t,bitrateMax:t}):this.videoQualityManager.setQuality({}),!this.hasDesktopSource()&&this.conn.setTransportOptions({encodingVideoBitRate:e,encodingVideoMinBitRate:n,encodingVideoMaxBitRate:t})}setEchoCancellation(e){this.echoCancellation=e,(0,T.getVoiceEngine)().setTransportOptions({echoCancellation:this.echoCancellation})}setNoiseSuppression(e){this.noiseSuppression=e,(0,T.getVoiceEngine)().setTransportOptions({noiseSuppression:this.noiseSuppression})}setAutomaticGainControl(e){this.automaticGainControl=e,(0,T.getVoiceEngine)().setTransportOptions({automaticGainControl:this.automaticGainControl})}setNoiseCancellation(e){this.noiseCancellation=e,(0,T.getVoiceEngine)().setTransportOptions({noiseCancellation:this.noiseCancellation})}setExperimentalEncoders(e){this.experimentalEncoders=e,this.conn.setTransportOptions({experimentalEncoders:this.experimentalEncoders})}setHardwareH264(e){this.hardwareH264=e,this.conn.setTransportOptions({hardwareH264:this.hardwareH264})}setQoS(e){this.qos=e,this.conn.setTransportOptions({qos:this.qos})}setInputMode(e,t){switch(this.inputMode=e,e){case A.InputModes.PUSH_TO_TALK:this.pttReleaseDelay=t.pttReleaseDelay;break;case A.InputModes.VOICE_ACTIVITY:this.vadThreshold=t.vadThreshold,this.vadAutoThreshold=t.vadAutoThreshold,this.vadUseKrisp=t.vadUseKrisp,this.vadLeading=t.vadLeading,this.vadTrailing=t.vadTrailing;break;default:throw Error(`Unknown Input Mode: ${e}`)}this.conn.setTransportOptions({inputMode:A.NATIVE_MODE_VALUES[this.inputMode],inputModeOptions:this.createInputModeOptions()})}setSilenceThreshold(e){(0,T.getVoiceEngine)().setNoInputThreshold(e)}setForceAudioInput(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t?this.forceAudioPriority=e:this.forceAudioNormal=e,this.conn.setPTTActive(this.forceAudioPriority||this.forceAudioNormal,this.forceAudioPriority)}setSpeakingFlags(e,t){null!=this.conn.setRemoteUserSpeakingStatus?this.conn.setRemoteUserSpeakingStatus(e,t):null!=this.conn.setRemoteUserSpeaking&&this.conn.setRemoteUserSpeaking(e,(t&A.SpeakingFlags.VOICE)===A.SpeakingFlags.VOICE),this.handleSpeakingFlags(e,t)}clearAllSpeaking(){}setEncryption(e,t){this.logger.info(`Selected encryption mode: ${e}`),this.conn.setTransportOptions({encryptionSettings:{mode:e,secretKey:t}})}setReconnectInterval(e){this.reconnectInterval=e,this.conn.setTransportOptions({reconnectInterval:this.reconnectInterval})}setKeyframeInterval(e){this.keyframeInterval=e,this.conn.setTransportOptions({keyframeInterval:this.getKeyFrameInterval(),alwaysSendVideo:this.keyframeInterval>0})}setVideoQualityMeasurement(e){this.videoQualityMeasurement=e,this.conn.setTransportOptions({videoQualityMeasurement:this.videoQualityMeasurement})}setVideoEncoderExperiments(e){this.videoEncoderExperiments=e,this.conn.setTransportOptions({videoEncoderExperiments:this.videoEncoderExperiments})}setVideoBroadcast(e){this.selfVideo!==e&&(this.selfVideo=e,this.applyVideoTransportOptions())}setGoLiveSource(e){let{resolution:t,frameRate:n}=e.quality,i=t<=480?t/3*4:t/9*16,r=null;if(null!=e.desktopDescription?r=e.desktopDescription.id:null!=e.cameraDescription&&(r=`${e.cameraDescription.videoDeviceGuid}:${e.cameraDescription.audioDeviceGuid}`),this.goLiveSourceIdentifier===r){this.setDesktopEncodingOptions(i,t,n);return}if(this.goLiveSourceIdentifier=r,null!=this.conn.setDesktopSource){if(null!=e.desktopDescription){let{id:t,soundshareId:n,useLoopback:i,useVideoHook:r,useGraphicsCapture:o,useQuartzCapturer:a,allowScreenCaptureKit:s,videoHookStaleFrameTimeoutMs:_,graphicsCaptureStaleFrameTimeoutMs:E,hdrCaptureMode:l}=e.desktopDescription;this.setSoundshareSource(n,i);let[u,I]=null!=t?t.split(\":\"):[\"\",\"\"];null!=t?this.logger.info(`capturing desktop (type: ${u}, handle: ${I}, use-video-hook: ${r.toString()}, use-graphics-capture: ${o?.toString()}).`):this.logger.info(\"capturing desktop (type: <stop>).\"),null!=this.conn.setDesktopSourceWithOptions?null!=t?this.conn.setDesktopSourceWithOptions({type:u,sourceId:I,useVideoHook:r,useGraphicsCapture:o,useQuartzCapturer:a,allowScreenCaptureKit:s,videoHookStaleFrameTimeoutMs:_,graphicsCaptureStaleFrameTimeoutMs:E,hdrCaptureMode:l}):this.conn.clearDesktopSource():this.conn.setDesktopSource(`wumpus-${I}`,r,u)}else if(null!=e.cameraDescription){let{videoDeviceGuid:t,audioDeviceGuid:n}=e.cameraDescription;this.conn.setGoLiveDevices({videoInputDeviceId:t,audioInputDeviceId:n})}this.setDesktopEncodingOptions(i,t,n)}}clearGoLiveDevices(){null!=this.goLiveSourceIdentifier&&this.setDesktopEncodingOptions(1280,720,30),null!=this.conn.clearGoLiveDevices&&this.conn.clearGoLiveDevices()}clearDesktopSource(){null!=this.goLiveSourceIdentifier&&this.setDesktopEncodingOptions(1280,720,30),this.goLiveSourceIdentifier=null,null!=this.conn.clearDesktopSource?this.conn.clearDesktopSource():this.conn.setDesktopSource(\"\",!1,\"\")}setDesktopSourceStatusCallback(e){this.conn.setDesktopSourceStatusCallback?.(e)}hasDesktopSource(){return null!=this.goLiveSourceIdentifier}setDesktopEncodingOptions(e,t,n){if(this.destroyed)return;let i=0===t&&n>=10||t>720||n>30?S.DESKTOP_BITRATE_ENHANCED:S.DESKTOP_BITRATE,r={width:e,height:t,framerate:n},o=this.videoQualityManager.getQuality();(!E.VideoQuality.equals(r,o.capture)||o.bitrateMax!==i)&&(this.videoQualityManager.setQuality({capture:r,bitrateMax:i}),this.videoStreamParameters.length>0&&(this.videoStreamParameters[0].maxResolution={type:0===e&&0===t?A.ResolutionTypes.SOURCE:A.ResolutionTypes.FIXED,width:e,height:t},this.videoStreamParameters[0].maxFrameRate=n,this.videoStreamParameters[0].maxBitrate=i),this.emit(l.BaseConnectionEvent.Video,this.ids.userId,null,this.audioSSRC,this.videoStreamParameters[0].ssrc,O(this.videoStreamParameters[0].ssrc),this.videoStreamParameters),this.conn.setTransportOptions(this.applyQualityConstraints().constraints))}setSDP(e){}setRemoteVideoSinkWants(e){this.remoteVideoSinkWants=e,this.updateVideoQuality(S.MEDIA_SINK_WANTS_PROPERTIES)}setLocalVideoSinkWants(e){let t=this.localVideoSinkWants;for(let[n,i]of Object.entries(this.remoteVideoSSRCs)){let r=0,o=0;for(let n of i)r+=t?.[n],o+=e?.[n];0===r&&0!==o&&this.conn.setDisableLocalVideo?.(n,!1),0!==r&&0===o&&this.conn.setDisableLocalVideo?.(n,!0)}this.localVideoSinkWants=e}startSamplesPlayback(e,t,n){if(e.numberOfChannels>2){n(1,\"Too many channels\");return}for(var i=[],r=0;r<e.numberOfChannels;r++){var o=e.getChannelData(r);i.push(o)}try{this.conn.startSamplesPlayback({sampleRate:e.sampleRate,volume:t},i,n)}catch(t){this.conn.startSamplesPlayback(e.sampleRate,i,n)}}stopSamplesPlayback(){this.conn.stopSamplesPlayback()}startSamplesLocalPlayback(e,t,n,i){if(t.numberOfChannels>2){i(1,\"Too many channels\");return}for(var r=[],o=0;o<t.numberOfChannels;o++){var a=t.getChannelData(o);r.push(a)}this.conn.startSamplesLocalPlayback(e,{sampleRate:t.sampleRate,volume:n},r,i)}stopAllSamplesLocalPlayback(){this.conn.stopAllSamplesLocalPlayback()}stopSamplesLocalPlayback(e){this.conn.stopSamplesLocalPlayback(e)}setBandwidthEstimationExperiments(e){this.conn.setTransportOptions({bandwidthEstimationExperiments:e})}updateVideoQualityCore(e,t){this.videoSupported&&!this.destroyed&&this.conn.setTransportOptions(e)}setStreamParameters(e){return new Promise((t,n)=>{for(let t of this.videoStreamParameters){let i=e.findIndex(e=>e.rid===t.rid);if(-1===i){n(Error(\"Invalid rid\"));return}let o=[];!r().isEqual(this.videoStreamParameters[i],e[i])&&(this.videoStreamParameters[i]={...e[i]},o.push({...e[i]})),this.conn.setTransportOptions({streamParameters:o})}t()})}applyVideoTransportOptions(){if(!this.videoSupported)return;let e=!1;this.hasDesktopSource()&&this.videoStreamParameters.length>0&&(e=this.videoStreamParameters[0].maxResolution?.type===A.ResolutionTypes.SOURCE),this.conn.setTransportOptions(this.applyQualityConstraints({encodingVideoDegradationPreference:this.hasDesktopSource()?e?this.sourceDesktopDegradationPreference:this.desktopDegradationPreference:this.videoDegradationPreference}).constraints),this.conn.setVideoBroadcast(this.selfVideo)}chooseEncryptionMode(e,t){for(let n of t)for(let t of e)if(n===t)return n;return\"xsalsa20_poly1305\"}getUserOptions(){return Object.keys(this.remoteAudioSSRCs).map(e=>{let t=void 0!==this.remoteVideoSSRCs[e]&&this.remoteVideoSSRCs[e].length>0?this.remoteVideoSSRCs[e][0]:0;return{id:e,ssrc:this.remoteAudioSSRCs[e],videoSsrc:t,videoSsrcs:this.remoteVideoSSRCs[e],rtxSsrc:O(t),mute:this.getLocalMute(e),volume:this.getLocalVolume(e)}})}createInputModeOptions(){switch(this.inputMode){case A.InputModes.VOICE_ACTIVITY:return{vadThreshold:this.vadThreshold,vadAutoThreshold:this.vadAutoThreshold?I.VADAggressiveness.VERY_AGGRESSIVE:I.VADAggressiveness.DISABLED,vadUseKrisp:this.vadUseKrisp,vadLeading:this.vadLeading,vadTrailing:this.vadTrailing};case A.InputModes.PUSH_TO_TALK:return{pttReleaseDelay:this.pttReleaseDelay};default:throw Error(`Unknown Input Mode: ${this.inputMode}`)}}getAttenuationOptions(){return{attenuation:this.isAttenuating(),attenuationFactor:this.attenuationFactor,attenuateWhileSpeakingSelf:this.attenuateWhileSpeakingSelf,attenuateWhileSpeakingOthers:this.attenuateWhileSpeakingOthers}}getCodecParams(e,t){return e!==A.Codecs.H264?{}:t?{\"level-asymmetry-allowed\":\"1\",\"packetization-mode\":\"1\",\"profile-level-id\":\"42e034\",\"hardware-h264\":this.hardwareH264&&this.useElectronVideo&&d.default.useDirectVideo?\"1\":\"0\"}:{\"level-asymmetry-allowed\":\"1\",\"packetization-mode\":\"1\",\"profile-level-id\":\"android\"===(0,T.getVoiceEngine)().platform?\"42e01f\":\"4d0033\",\"hardware-h264\":this.hardwareH264&&this.useElectronVideo&&d.default.useDirectVideo?\"1\":\"0\"}}getCodecOptions(e,t,n){let i;i=this.codecs.find(t=>t.name===e);let r={type:i?.payloadType??0,name:e,freq:48e3,pacsize:960,channels:1,rate:64e3},o=[{type:i?.payloadType??0,name:e,freq:48e3,channels:2,params:{stereo:\"1\"}}];n===A.MediaEngineContextTypes.STREAM&&(r.channels=2);let a=[],s={name:\"\",type:0,rtxType:0,params:{}};for(i of this.codecs){if(i.name===e)continue;let n={name:(0,u.codecNameToPayloadName)(i.name),type:i?.payloadType??0,rtxType:i?.rtxPayloadType??0,params:this.getCodecParams(i.name,!0)};a.push(n),i.name===t&&(s={...n,params:this.getCodecParams(i.name,!1)},this.experimentFlags.has(S.ExperimentFlags.VIDEOTOOLBOX_RATE_CONTROL)&&(s.params[\"fixed-rate-presentation-timestamps\"]=\"1\"))}return{videoEncoder:s,videoDecoders:a,audioEncoder:r,audioDecoders:o}}getKeyFrameInterval(){return this.keyframeInterval>0&&this.clipsKeyFrameInterval>0?Math.min(this.keyframeInterval,this.clipsKeyFrameInterval):Math.max(this.keyframeInterval,this.clipsKeyFrameInterval)}getConnectionTransportOptions(){let e={selfMute:this.selfMute,inputMode:A.NATIVE_MODE_VALUES[this.inputMode],inputModeOptions:this.createInputModeOptions(),minimumJitterBufferLevel:this.minimumJitterBufferLevel,postponeDecodeLevel:this.postponeDecodeLevel,...this.getAttenuationOptions(),fec:!0,packetLossRate:.3,qos:this.qos,prioritySpeakerDucking:A.DEFAULT_PRIORITY_SPEAKER_DUCKING,encodingVoiceBitRate:this.voiceBitrate,callBitRate:A.DEFAULT_CALL_BITRATE,callMinBitRate:A.DEFAULT_CALL_MIN_BITRATE,callMaxBitRate:A.DEFAULT_CALL_MAX_BITRATE,encodingVideoDegradationPreference:this.videoDegradationPreference,experimentalEncoders:this.experimentalEncoders,hardwareH264:this.hardwareH264,reconnectInterval:this.reconnectInterval,userChannelIds:this.ids};return(0,T.supportsFeature)(A.NativeFeatures.VIDEO_EFFECTS)&&this.context===A.MediaEngineContextTypes.STREAM&&(e.enableVideoEffects=!0),e}setStream(e){throw Error(\"Method not implemented.\")}getUserIdBySsrc(e){}setRtcLogEphemeralKey(e){this.conn.setTransportOptions({userChannelIds:this.ids,rtcLogEphemeralKey:e})}setRtcLogMarker(e){null!=this.conn.setRtcLogMarker&&this.conn.setRtcLogMarker(e)}prepareSecureFramesTransition(e,t,n){this.conn.prepareSecureFramesTransition?.(e,t,n)}prepareSecureFramesEpoch(e,t,n){this.conn.prepareSecureFramesEpoch?.(e,t,n)}executeSecureFramesTransition(e){this.conn.executeSecureFramesTransition?.(e)}getMLSKeyPackage(e){this.conn.getMLSKeyPackage?.(e)}updateMLSExternalSender(e){this.conn.updateMLSExternalSender?.(e)}processMLSProposals(e,t){this.conn.processMLSProposals?.(e,t)}prepareMLSCommitTransition(e,t,n){this.conn.prepareMLSCommitTransition?.(e,t,n)}processMLSWelcome(e,t,n){this.conn.processMLSWelcome?.(e,t,n)}}"
    }
}